<div class="registration page-rtl container-fluid" dir="rtl" [formGroup]="form">
  <div class="row g-4">
    <!-- ===== 1) بيانات المشترك ===== -->
    <div class="col-12 col-lg-4">
      <div class="card fancy-card card--glass shadow-sm h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-person-badge-fill"></i>
            <h5 class="mb-0 fw-bold">بيانات المشترك</h5>
          </div>
          <span class="badge pill badge--info">جديد</span>
        </div>

        <div class="card-body">
          <!-- <div class="mb-3">
            <label class="form-label">رقم الكارت</label>
            <input class="form-control" formControlName="cardNo" placeholder="مثال: 123456" />
            <div class="invalid-feedback d-block" *ngIf="hasErr('cardNo')">
              برجاء إدخال رقم كارت صحيح
            </div>
          </div> -->

          <div class="mb-3">
            <label class="form-label d-block">رقم السيارة</label>
            <div class="plate-input" formGroupName="plate">
              <input maxlength="5" class="w-100" formControlName="p1" />
              <span class="sep">ـ</span>
              <input maxlength="5" class="w-100" formControlName="p4" />
            </div>
            <div
              class="invalid-feedback d-block"
              *ngIf="form.get('plate')?.touched && form.get('plate')?.invalid"
            >
              برجاء استكمال خانات لوحة السيارة
            </div>
          </div>

          <div class="row">
            <div class="mb-3 col-12">
              <label class="form-label">اسم المشترك</label>
              <input
                class="form-control"
                formControlName="subscriberName"
                placeholder="مثال: حسام خالد"
              />
              <div class="invalid-feedback d-block" *ngIf="hasErr('subscriberName')">
                الاسم مطلوب
              </div>
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">رقم التليفون</label>
              <input class="form-control" formControlName="phone" placeholder="مثال: 01012345678" />
              <div class="invalid-feedback d-block" *ngIf="hasErr('phone')">رقم هاتف غير صالح</div>
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">رقم البطاقة</label>
              <input
                class="form-control"
                formControlName="nationalId"
                placeholder="مثال: 2980*********"
              />
              <div class="invalid-feedback d-block" *ngIf="hasErr('nationalId')">
                رقم بطاقة غير صالح
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 2) تفاصيل الاشتراك ===== -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm card--glass h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0 fw-bold">نوع الاشتراك</h5>
          <span *ngIf="loadingSchemas()" class="text-muted small">جاري التحميل…</span>
        </div>

        <div class="card-body" [formGroup]="form">
          <div class="mb-3">
            <label class="form-label">اختر نوع الاشتراك</label>
            <select class="form-select" formControlName="pricingSchemaId">
              <option [ngValue]="null" disabled selected>— اختر نوع الاشتراك —</option>
              <option *ngFor="let s of schemas()" [value]="s.id">{{ s.name }}</option>
            </select>
            <div
              class="invalid-feedback d-block"
              *ngIf="form.get('pricingSchemaId')?.invalid && form.touched"
            >
              اختيار نوع الاشتراك مطلوب
            </div>
          </div>

          <hr class="my-4" />

          <!-- بيانات الكارت -->
          <h6 class="fw-bold mb-3">بيانات الكارت</h6>

          <div class="mb-3">
            <label class="form-label">رقم الكارت</label>
            <input class="form-control" formControlName="cardNo" placeholder="مثال: 123456" />
          </div>

          <div class="mb-3">
            <!-- <label class="form-label">رقم الكارت</label> -->
            <div class="d-flex gap-2">
              <!-- <input class="form-control" formControlName="cardNo" placeholder="مثال: 19F7A7B3" /> -->
              <button
                class="btn btn-outline-primary"
                type="button"
                (click)="readCard()"
                [disabled]="readingCard()"
                title="قراءة UID من القارئ"
              >
                <i class="bi bi-upc-scan"></i>
                <span class="ms-1">{{ readingCard() ? 'جاري القراءة…' : 'قراءة الكارت' }}</span>
              </button>
            </div>
            <div class="invalid-feedback d-block" *ngIf="hasErr('cardNo')">
              رقم الكارت يجب أن يكون أحرف/أرقام هيكس بين 6 و 16.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== 3) المستندات ===== -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm card--glass h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0 fw-bold">المستندات</h5>
          <span class="badge bg-secondary">{{ documents().length }} ملف</span>
        </div>

        <div class="card-body">
          <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
            <label class="form-label m-0">رفع مستندات</label>

            <!-- رفع ملفات عادي -->
            <input
              type="file"
              multiple
              (change)="onPickDocuments($event)"
              accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
            />

            <!-- زر الماسح (الكاميرا) -->
            <button
              type="button"
              class="btn btn-outline-primary btn-sm"
              (click)="openScanner(camInput)"
            >
              <i class="bi bi-camera"></i>
              مسح بالمـاسـح/الكاميرا
            </button>

            <!-- إدخال كاميرا مخفي: يفتح بالكليك على الزر -->
            <input
              #camInput
              type="file"
              capture="environment"
              accept="image/*"
              style="display: none"
              (change)="onPickDocuments($event)"
            />
          </div>

          <div class="docs-grid" *ngIf="documents().length; else noDocs">
            <div class="doc-item" *ngFor="let d of documents(); let i = index">
              <button class="doc-thumb" type="button" (click)="openPreview(d)">
                <ng-container *ngIf="d.isImage; else fileIcon">
                  <img [src]="d.dataUrl" [alt]="d.name" />
                </ng-container>
                <ng-template #fileIcon>
                  <div class="doc-icon"><i class="bi bi-file-earmark-text"></i></div>
                </ng-template>
              </button>
              <div class="doc-meta">
                <div class="doc-name" [title]="d.name">{{ d.name }}</div>
                <div class="doc-sub">{{ d.mime }} • {{ humanSize(d.size) }}</div>
              </div>
              <button class="btn btn-sm btn-outline-danger w-100 mt-2" (click)="removeDocument(i)">
                <i class="bi bi-trash3"></i> حذف
              </button>
            </div>
          </div>
          <ng-template #noDocs>
            <div class="text-muted">لا توجد مستندات مرفوعة بعد.</div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <div
    class="preview-overlay"
    *ngIf="previewOpen()"
    (click)="closePreview($event)"
    (keydown.escape)="forceClose()"
    tabindex="0"
  >
    <div class="preview-dialog" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="forceClose()" aria-label="إغلاق">
        <i class="bi bi-x-lg"></i>
      </button>
      <ng-container *ngIf="currentPreview(); let p">
        <div class="preview-head">
          <div class="name" [title]="p.name">{{ p.name }}</div>
          <div class="sub">{{ p.mime }} • {{ humanSize(p.size) }}</div>
        </div>
        <div class="preview-body">
          <ng-container *ngIf="p.isImage; else nonImage">
            <img [src]="p.dataUrl" [alt]="p.name" />
          </ng-container>
          <ng-template #nonImage>
            <div class="file-preview">
              <i class="bi bi-file-earmark-text"></i>
              <p class="mt-2">لا يمكن معاينة هذا النوع هنا. يمكنك تنزيله لفتحه محلياً.</p>
              <a [href]="p.dataUrl" download="{{ p.name }}" class="btn btn-primary">
                <i class="bi bi-download"></i> تنزيل الملف
              </a>
            </div>
          </ng-template>
        </div>
      </ng-container>
    </div>
  </div>
</div>
