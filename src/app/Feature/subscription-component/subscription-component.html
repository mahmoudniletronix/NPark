<div class="subscription container-fluid" [class.page-rtl]="isRTL()" [attr.dir]="dir()">
  <div class="row g-4">
    <!-- ==== Form ==== -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm fancy-card card--glass">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-badge-ad fill"></i>
            <h5 class="mb-0 fw-bold">{{ t('title') }}</h5>
          </div>
          <span class="badge pill badge--info">
            {{ editingId() ? t('edit') : t('add') }}
          </span>
        </div>

        <div class="card-body" [formGroup]="form">
          <!-- Field: Name -->
          <div class="mb-3">
            <label class="form-label">{{ t('field_name') }}</label>
            <input
              class="form-control"
              formControlName="name"
              [placeholder]="t('name_placeholder')"
            />
            <div
              class="invalid-feedback d-block"
              *ngIf="form.get('name')?.touched && form.get('name')?.invalid"
            >
              {{ t('name_required') }}
            </div>
          </div>

          <!-- Field: Duration Type -->
          <div class="mb-3">
            <label class="form-label">{{ t('duration_type') }}</label>
            <div class="btn-group w-100 mode-toggle" role="group">
              <button
                type="button"
                class="btn btn-ghost ms-2"
                [class.btn-primary]="form.value.durationType === DurationType.Hours"
                [class.btn-outline-primary]="form.value.durationType !== DurationType.Hours"
                (click)="setMode(DurationType.Hours)"
                [title]="t('hours')"
              >
                <i class="bi bi-clock"></i>
                {{ t('hours') }}
              </button>

              <button
                type="button"
                class="btn btn-ghost"
                [class.btn-primary]="form.value.durationType === DurationType.Days"
                [class.btn-outline-primary]="form.value.durationType !== DurationType.Days"
                (click)="setMode(DurationType.Days)"
                [title]="t('days')"
              >
                <i class="bi bi-calendar3"></i>
                {{ t('days') }}
              </button>

              <button
                type="button"
                class="btn btn-ghost me-2"
                [class.btn-primary]="form.value.durationType === DurationType.Year"
                [class.btn-outline-primary]="form.value.durationType !== DurationType.Year"
                (click)="setMode(DurationType.Year)"
                [title]="t('year')"
              >
                <i class="bi bi-calendar-check"></i>
                {{ t('year') }}
              </button>
            </div>
          </div>

          <!-- Toggle: Repeated (only for Hours) -->
          <div class="col-12 d-flex align-items-center mt-2 gap-2" *ngIf="showIsRepeated()">
            <label class="form-label mb-0">{{ t('repeated') }}</label>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                role="switch"
                formControlName="isRepeated"
              />
            </div>
          </div>

          <!-- Time Window -->
          <div class="row g-2 mb-3" *ngIf="showRangeWindow()">
            <div class="col-6">
              <label class="form-label">{{ t('from') }}</label>
              <input type="time" class="form-control" formControlName="startTime" />
            </div>
            <div class="col-6">
              <label class="form-label">{{ t('to') }}</label>
              <input type="time" class="form-control" formControlName="endTime" />
            </div>
          </div>

          <!-- Total Hours -->
          <div class="mb-3" *ngIf="isHours()">
            <label class="form-label">{{ t('total_hours') }}</label>
            <input
              type="number"
              class="form-control"
              formControlName="totalHours"
              min="1"
              step="1"
              placeholder="12"
            />
            <div
              class="invalid-feedback d-block"
              *ngIf="form.get('totalHours')?.touched && form.get('totalHours')?.invalid"
            >
              {{ t('total_hours_required') }}
            </div>
          </div>

          <!-- Total Days -->
          <div class="mb-3" *ngIf="isDays()">
            <label class="form-label">{{ t('total_days') }}</label>
            <input
              type="number"
              class="form-control"
              formControlName="totalDays"
              min="1"
              step="1"
              placeholder="30"
            />
            <div
              class="invalid-feedback d-block"
              *ngIf="form.get('totalDays')?.touched && form.get('totalDays')?.invalid"
            >
              {{ t('total_days_required') }}
            </div>
          </div>

          <!-- Price -->
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">{{ t('price_label') }}</label>
              <input
                type="number"
                class="form-control"
                formControlName="price"
                min="0"
                step="0.5"
              />
              <div
                class="invalid-feedback d-block"
                *ngIf="form.get('price')?.touched && form.get('price')?.invalid"
              >
                {{ t('price_required') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="card-footer d-flex gap-2 justify-content-end">
          <button class="btn btn-light btn-soft" type="button" (click)="resetForm()">
            <i class="bi bi-arrow-repeat"></i> {{ t('reset') }}
          </button>
          <button
            class="btn btn-primary btn-raised"
            type="button"
            (click)="save()"
            [disabled]="loading() || saving()"
          >
            <i class="bi bi-save"></i> {{ t('save') }}
          </button>
        </div>
      </div>
    </div>

    <!-- ==== Table ==== -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm fancy-card card--glass">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-table"></i>
            <h6 class="mb-0">{{ t('list_title') }}</h6>
          </div>
          <!-- Top Search -->
          <div class="search-wrap">
            <i class="bi bi-search"></i>
            <input
              #searchBoxTop
              class="form-control form-control-sm"
              [placeholder]="t('search_placeholder')"
              [value]="query()"
              (input)="query.set(searchBoxTop.value)"
            />
          </div>
        </div>

        <!-- Table -->
        <div class="card-body p-0 table-responsive">
          <table class="table table-hover align-middle mb-0 table-striped table-modern">
            <thead class="table-light sticky-top">
              <tr>
                <th class="text-center">{{ t('col_index') }}</th>
                <th>{{ t('col_name') }}</th>
                <th>{{ t('col_type') }}</th>
                <th>{{ t('col_from') }}</th>
                <th>{{ t('col_to') }}</th>
                <th>{{ t('col_price') }}</th>
                <th class="text-end">{{ t('col_actions') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of filtered(); let i = index" class="row-hover">
                <td class="text-center">{{ (page() - 1) * pageSize() + (i + 1) }}</td>
                <td class="fw-semibold">
                  <i class="bi bi-card-checklist ms-2 text-primary"></i>{{ r.name }}
                </td>
                <td>
                  <span class="badge pill badge--secondary">
                    {{ durationLabel(r.durationType) }}
                  </span>
                </td>
                <td>{{ showTimeForRow(r) ? r.startTime || '00:00' : t('time_window_off') }}</td>
                <td>{{ showTimeForRow(r) ? r.endTime || '00:00' : t('time_window_off') }}</td>
                <td>
                  <span class="badge pill badge--success">
                    {{ r.price | number : '1.0-2' }}
                  </span>
                </td>
                <td class="text-end d-flex gap-1">
                  <button
                    class="btn btn-sm btn-outline-primary me-1 btn-icon"
                    (click)="edit(r)"
                    [title]="t('edit_action')"
                  >
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger btn-icon"
                    (click)="remove(r)"
                    [disabled]="!normalizeId(r)"
                    [title]="t('delete_action')"
                  >
                    <i class="bi bi-trash3"></i>
                  </button>
                </td>
              </tr>

              <!-- Empty State -->
              <tr *ngIf="!filtered().length">
                <td colspan="7" class="text-center text-muted py-4">
                  {{ t('empty_search') }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Footer: Pagination + Search -->
        <div class="card-footer small text-muted d-flex align-items-center justify-content-between">
          <span>
            <i class="bi bi-info-circle"></i>
            {{ t('total_label') }} {{ totalItems() }} â€” {{ t('page') }} {{ page() }} {{ t('of') }}
            {{ totalPages() }}
          </span>

          <div class="d-flex align-items-center gap-2">
            <div class="search-wrap me-2">
              <i class="bi bi-search"></i>
              <input
                #searchBox
                class="form-control form-control-sm"
                [placeholder]="t('search_placeholder')"
                [value]="query()"
                (input)="onSearch(searchBox.value)"
              />
            </div>

            <div class="btn-group" dir="ltr">
              <button
                class="btn btn-sm btn-outline-secondary"
                [disabled]="!hasNext()"
                (click)="goNext()"
              >
                {{ t('next') }}
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                [disabled]="!hasPrev()"
                (click)="goPrev()"
              >
                {{ t('prev') }}
              </button>
            </div>
          </div>
        </div>

        <!-- Footer: Back link -->
        <div class="card-footer small text-muted d-flex align-items-center justify-content-between">
          <span>
            <i class="bi bi-info-circle"></i>
            {{ t('last_n_hint') }} {{ filtered().length }} {{ t('slice_hint') }}
          </span>
          <a routerLink="/dashboard" class="link-underline link-underline-opacity-0">
            {{ t('back_dashboard') }}
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
