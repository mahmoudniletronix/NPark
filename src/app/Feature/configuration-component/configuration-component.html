<div class="container" dir="rtl">
  <div class="layout">
    <!-- Wizard -->
    <mat-card class="main">
      <mat-horizontal-stepper
        [linear]="true"
        [selectedIndex]="stepIndex"
        (selectionChange)="stepIndex = $event.selectedIndex"
      >
        <!-- ===== Step 1 ===== -->
        <mat-step [stepControl]="step1Form" label="الأساسيات">
          <form [formGroup]="step1Form" class="grid">
            <mat-form-field appearance="outline">
              <mat-label>عدد بوابات الدخول</mat-label>
              <input matInput type="number" formControlName="entryGatesCount" min="1" required />
              <mat-error *ngIf="step1Form.get('entryGatesCount')?.invalid">أدخل رقم ≥ 1</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>عدد بوابات الخروج</mat-label>
              <input matInput type="number" formControlName="exitGatesCount" min="1" required />
              <mat-error *ngIf="step1Form.get('exitGatesCount')?.invalid">أدخل رقم ≥ 1</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>عدد الباكيّات المسموح</mat-label>
              <input
                matInput
                type="number"
                formControlName="allowedParkingSlots"
                min="1"
                required
              />
              <mat-error *ngIf="step1Form.get('allowedParkingSlots')?.invalid">
                أدخل رقم ≥ 1
              </mat-error>
            </mat-form-field>

            <div class="actions">
              <button
                mat-flat-button
                color="primary"
                (click)="goNext()"
                [disabled]="step1Form.invalid"
              >
                التالي
              </button>
            </div>
          </form>
        </mat-step>

        <!-- ===== Step 2 ===== -->
        <mat-step [stepControl]="step2Form" label="الوضع والإعدادات">
          <form [formGroup]="step2Form">
            <div class="section">
              <label class="section-title">الوضع</label>
              <mat-radio-group [formControl]="modeCtrl" class="row">
                <mat-radio-button value="entry">Entry (دخول)</mat-radio-button>
                <mat-radio-button value="exit">Exit (خروج)</mat-radio-button>
              </mat-radio-group>
            </div>

            <mat-divider></mat-divider>

            <div class="grid">
              <!-- Capture targets -->
              <div formGroupName="captureTargets" class="inline">
                <label class="section-title">Vehicle & Passenger</label>
                <mat-checkbox formControlName="vehicle">Vehicle</mat-checkbox>
                <mat-checkbox formControlName="passenger">Passenger</mat-checkbox>
              </div>

              <!-- Capture mode -->
              <mat-form-field appearance="outline">
                <mat-label>طريقة الالتقاط</mat-label>
                <mat-select formControlName="captureMode" required>
                  <mat-option value="LPR">LPR Cam</mat-option>
                  <mat-option value="ScannerID">ScannerID Cam</mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Print type -->
              <mat-form-field appearance="outline">
                <mat-label>أنواع التذاكر</mat-label>
                <mat-select formControlName="printType" required>
                  <mat-option value="QR">QR</mat-option>
                  <mat-option value="RFID">RFID</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <!-- Flags inline row -->
            <div class="section">
              <label class="section-title">حقول الطباعة والإظهار</label>

              <div class="flags-row" [formGroup]="step2Form">
                <mat-slide-toggle formControlName="dateTimeFlag">الوقت/التاريخ</mat-slide-toggle>
                <mat-slide-toggle formControlName="ticketIdFlag">رقم التذكرة</mat-slide-toggle>
                <mat-slide-toggle formControlName="feesFlag">الرسوم</mat-slide-toggle>
                <mat-slide-toggle formControlName="pricingSchemaIdFlag">
                  Pricing Schema
                </mat-slide-toggle>

                <!-- Dropdown Pricing Schema-->
                <mat-form-field appearance="outline" class="schema-select mt-3">
                  <mat-label>Pricing Schema</mat-label>
                  <mat-select
                    formControlName="pricingSchemaId"
                    [disabled]="!step2Form.get('pricingSchemaIdFlag')?.value"
                  >
                    <mat-option value="">اختر الشريحة...</mat-option>
                    <mat-option *ngFor="let s of pricingSchemas" [value]="s.id">
                      {{ s.name }} — {{ s.description || '' }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="step2Form.get('pricingSchemaId')?.invalid">
                    يجب اختيار شريحة تسعير صحيحة
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <!-- Exit tiers -->
            <div class="section">
              <div *ngIf="modeCtrl.value === 'exit'" class="tiers">
                <div class="tiers-head">
                  <span>شرائح الرسوم</span>
                  <button mat-stroked-button color="primary" type="button" (click)="addTier()">
                    <mat-icon>add</mat-icon> إضافة شريحة
                  </button>
                </div>

                <div class="table-wrap">
                  <table mat-table [dataSource]="tiersControls" class="mat-elevation-z1">
                    <ng-container matColumnDef="idx">
                      <th mat-header-cell *matHeaderCellDef>#</th>
                      <td mat-cell *matCellDef="let row; let i = index">{{ i + 1 }}</td>
                    </ng-container>

                    <ng-container matColumnDef="from">
                      <th mat-header-cell *matHeaderCellDef>من (س)</th>
                      <td mat-cell *matCellDef="let row; let i = index" [formGroup]="row">
                        <input matInput type="number" formControlName="fromHour" min="0" />
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="to">
                      <th mat-header-cell *matHeaderCellDef>إلى (س)</th>
                      <td mat-cell *matCellDef="let row" [formGroup]="row">
                        <input matInput type="number" formControlName="toHour" min="0" />
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="price">
                      <th mat-header-cell *matHeaderCellDef>السعر</th>
                      <td mat-cell *matCellDef="let row" [formGroup]="row">
                        <input matInput type="number" formControlName="price" min="0" />
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="act">
                      <th mat-header-cell *matHeaderCellDef></th>
                      <td mat-cell *matCellDef="let row; let i = index">
                        <button mat-icon-button color="warn" type="button" (click)="removeTier(i)">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="tierCols"></tr>
                    <tr mat-row *matRowDef="let r; columns: tierCols"></tr>
                  </table>
                </div>

                <mat-hint align="start" class="muted">مثال: 0–2، ثم 2–6 … بدون تداخل.</mat-hint>
              </div>
            </div>

            <mat-divider class="my-3"></mat-divider>

            <div class="flex-between">
              <button mat-button type="button" (click)="goBack()">
                <mat-icon>chevron_right</mat-icon> رجوع
              </button>
              <button mat-flat-button color="primary" type="button" (click)="save()">حفظ</button>
            </div>
          </form>
        </mat-step>
      </mat-horizontal-stepper>
    </mat-card>

    <!-- Summary -->
    <mat-card class="summary mat-elevation-z2">
      <h3 class="sum-title">الملخّص</h3>

      <div class="sum-line">
        <span class="muted">بوابات الدخول</span>
        <span class="bold">{{ summaryForView.entryGatesCount }}</span>
      </div>

      <div class="sum-line">
        <span class="muted">بوابات الخروج</span>
        <span class="bold">{{ summaryForView.exitGatesCount }}</span>
      </div>

      <div class="sum-line">
        <span class="muted">عدد الباكيّات المسموح</span>
        <span class="bold">{{ summaryForView.allowedParkingSlots }}</span>
      </div>

      <div class="sum-line">
        <span class="muted">الوضع</span>
        <span class="bold">{{ summaryForView.mode === 'entry' ? 'Entry' : 'Exit' }}</span>
      </div>

      <div class="sum-line">
        <span class="muted">طريقة الالتقاط</span>
        <span class="bold">{{ summaryForView.captureMode }}</span>
      </div>

      <div class="sum-line">
        <span class="muted">الطباعة</span>
        <span class="bold">{{ summaryForView.printType }}</span>
      </div>

      <div class="sum-line">
        <span class="muted">Start Date</span>
        <span class="bold">{{ summaryForView.ticketCard.startDate | date : 'yyyy-MM-dd' }}</span>
      </div>

      <ng-container *ngIf="summaryForView.mode === 'entry'; else tiersTpl">
        <div class="sum-line">
          <span class="muted">Fees (once)</span>
          <span class="bold color">{{ summaryForView.ticketCard.fees }}</span>
        </div>
      </ng-container>

      <ng-template #tiersTpl>
        <div class="small muted mb-1">شرائح الرسوم</div>
        <div class="tier" *ngFor="let f of summaryForView.ticketCard.fees; let i = index">
          <span>#{{ i + 1 }}: {{ f.fromHour }}–{{ f.toHour }} س</span>
          <span class="bold color">{{ f.price }}</span>
        </div>
      </ng-template>

      <mat-divider class="my-2"></mat-divider>

      <div class="small muted">بطاقة الطباعة</div>
      <div class="sum-line">
        <span>Ticket ID Prefix</span>
        <span class="bold">{{ summaryForView.ticketCard.ticketIdPrefix || 'TK' }}</span>
      </div>

      <mat-divider class="my-2"></mat-divider>

      <div class="small muted">الخيارات (Flags)</div>
      <div class="sum-line">
        <span class="muted">التاريخ/الوقت</span>
        <span class="bold">{{ summaryForView.flags.dateTimeFlag ? 'مُفعّل' : 'مُعطّل' }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">رقم التذكرة</span>
        <span class="bold">{{ summaryForView.flags.ticketIdFlag ? 'مُفعّل' : 'مُعطّل' }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">الرسوم</span>
        <span class="bold">{{ summaryForView.flags.feesFlag ? 'مُفعّل' : 'مُعطّل' }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">Pricing Schema</span>
        <span class="bold">
          {{ summaryForView.flags.pricingSchemaIdFlag ? 'مُفعّل' : 'مُعطّل' }}
        </span>
      </div>

      <div class="sum-line" *ngIf="summaryForView.flags.pricingSchemaIdFlag">
        <span>Schema Id</span>
        <span class="bold">{{ summaryForView.pricingSchemaId }}</span>
      </div>
    </mat-card>
  </div>
</div>
