<div class="container" dir="rtl">
  <div class="layout">
    <!-- Wizard -->
    <mat-card class="main">
      <mat-horizontal-stepper
        [linear]="true"
        [selectedIndex]="stepIndex"
        (selectionChange)="stepIndex = $event.selectedIndex"
      >
        <!-- ===== Step 1 ===== -->
        <mat-step [stepControl]="step1Form" label="الأساسيات">
          <form [formGroup]="step1Form" class="grid">
            <mat-form-field appearance="outline">
              <mat-label>عدد بوابات الدخول</mat-label>
              <input matInput type="number" formControlName="entryGatesCount" min="1" required />
              <mat-error *ngIf="step1Form.get('entryGatesCount')?.invalid">أدخل رقم ≥ 1</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>عدد بوابات الخروج</mat-label>
              <input matInput type="number" formControlName="exitGatesCount" min="1" required />
              <mat-error *ngIf="step1Form.get('exitGatesCount')?.invalid">أدخل رقم ≥ 1</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>عدد الباكيّات المسموح</mat-label>
              <input
                matInput
                type="number"
                formControlName="allowedParkingSlots"
                min="1"
                required
              />
              <mat-error *ngIf="step1Form.get('allowedParkingSlots')?.invalid"
                >أدخل رقم ≥ 1</mat-error
              >
            </mat-form-field>
            <!-- NEW: Grace Period -->
            <mat-form-field appearance="outline">
              <mat-label>فترة السماح (دقائق)</mat-label>
              <input matInput type="number" formControlName="gracePeriodMinutes" min="0" required />
              <mat-hint>عدد الدقائق المسموح بها قبل احتساب الرسوم</mat-hint>
              <mat-error *ngIf="step1Form.get('gracePeriodMinutes')?.invalid"
                >أدخل رقم ≥ 0</mat-error
              >
            </mat-form-field>
            <div class="actions">
              <button
                mat-flat-button
                color="primary"
                (click)="goNext()"
                [disabled]="step1Form.invalid"
              >
                التالي
              </button>
            </div>
          </form>
        </mat-step>
        <!-- ===== Step 2 ===== -->
        <mat-step [stepControl]="step2Form" label="الوضع والإعدادات">
          <form [formGroup]="step2Form">
            <div class="section">
              <label class="section-title">الوضع</label>
              <mat-radio-group [formControl]="modeCtrl" class="row">
                <mat-radio-button value="entry">Entry (دخول)</mat-radio-button>
                <mat-radio-button value="exit">Exit (خروج)</mat-radio-button>
              </mat-radio-group>
            </div>
            <mat-divider></mat-divider>
            <label class="section-title">Vehicle & Passenger</label>
            <div class="grid">
              <!-- Capture mode -->
              <mat-form-field appearance="outline">
                <mat-label>طريقة الالتقاط</mat-label>
                <mat-select formControlName="captureMode" required>
                  <mat-option value="LPR">LPR Cam</mat-option>
                  <mat-option value="ScannerID">ScannerID Cam</mat-option>
                </mat-select>
              </mat-form-field>
              <!-- Print type -->
              <mat-form-field appearance="outline">
                <mat-label>أنواع التذاكر</mat-label>
                <mat-select formControlName="printType" required>
                  <mat-option value="QR">QR</mat-option>
                  <mat-option value="RFID">RFID</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <mat-divider class="my-3"></mat-divider>

            <div class="horizontal-accordion">
              <!-- Entry Gates Main Accordion -->
              <div class="main-accordion">
                <mat-expansion-panel [expanded]="false">
                  <mat-expansion-panel-header>
                    <div class="accordion-header">
                      <mat-panel-title>
                        <mat-icon class="gate-icon">door_front</mat-icon>
                        بوابات الدخول
                      </mat-panel-title>
                      <span class="gate-count">{{ entryGatesControls.length }}</span>
                    </div>
                  </mat-expansion-panel-header>

                  <!-- Individual Gates Grid -->
                  <div class="gates-grid">
                    <div formArrayName="entryGates">
                      <div
                        class="gate-accordion"
                        *ngFor="let g of entryGatesControls; let i = index"
                        [formGroupName]="i"
                      >
                        <mat-expansion-panel>
                          <mat-expansion-panel-header>
                            <mat-panel-title>
                              <mat-icon class="gate-icon">door_front</mat-icon>
                              البوابة {{ g.get('gateNumber')?.value }}
                            </mat-panel-title>
                          </mat-expansion-panel-header>

                          <div class="gate-details">
                            <div class="gate-info">
                              <div class="gate-number">
                                <mat-icon class="gate-icon">numbers</mat-icon>
                                رقم البوابة: {{ g.get('gateNumber')?.value }}
                              </div>
                              <div class="device-name">
                                <mat-icon class="device-icon">devices</mat-icon>
                                الجهاز: {{ g.get('lprIp')?.value || 'غير محدد' }}
                              </div>
                              <div class="ip-input-container">
                                <label class="ip-label">عنوان IP للكاميرا</label>
                                <input
                                  class="ip-address"
                                  type="text"
                                  [formControlName]="'lprIp'"
                                  placeholder="مثال: 192.168.1.100"
                                />
                              </div>
                            </div>
                          </div>
                        </mat-expansion-panel>
                      </div>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>

              <!-- Exit Gates Main Accordion -->
              <div class="main-accordion">
                <mat-expansion-panel [expanded]="false">
                  <mat-expansion-panel-header>
                    <div class="accordion-header">
                      <mat-panel-title>
                        <mat-icon class="gate-icon">exit_to_app</mat-icon>
                        بوابات الخروج
                      </mat-panel-title>
                      <span class="gate-count">{{ exitGatesControls.length }}</span>
                    </div>
                  </mat-expansion-panel-header>

                  <!-- Individual Gates Grid -->
                  <div class="gates-grid">
                    <div formArrayName="exitGates">
                      <div
                        class="gate-accordion"
                        *ngFor="let g of exitGatesControls; let i = index"
                        [formGroupName]="i"
                      >
                        <mat-expansion-panel>
                          <mat-expansion-panel-header>
                            <mat-panel-title>
                              <mat-icon class="gate-icon">exit_to_app</mat-icon>
                              البوابة {{ g.get('gateNumber')?.value }}
                            </mat-panel-title>
                          </mat-expansion-panel-header>

                          <div class="gate-details">
                            <div class="gate-info">
                              <div class="gate-number">
                                <mat-icon class="gate-icon">numbers</mat-icon>
                                رقم البوابة: {{ g.get('gateNumber')?.value }}
                              </div>
                              <div class="device-name">
                                <mat-icon class="device-icon">devices</mat-icon>
                                الجهاز: {{ g.get('lprIp')?.value || 'غير محدد' }}
                              </div>
                              <div class="ip-input-container">
                                <label class="ip-label">عنوان IP للكاميرا</label>
                                <input
                                  class="ip-address"
                                  type="text"
                                  [formControlName]="'lprIp'"
                                  placeholder="مثال: 192.168.1.100"
                                />
                              </div>
                            </div>
                          </div>
                        </mat-expansion-panel>
                      </div>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>
            </div>

            <div class="flex-between">
              <button mat-stroked-button type="button" (click)="goBack()">رجوع</button>
              <button mat-flat-button color="primary" type="button" (click)="save()">حفظ</button>
            </div>
          </form>
        </mat-step>
      </mat-horizontal-stepper>
    </mat-card>
    <!-- Summary -->
    <mat-card class="summary mat-elevation-z2">
      <h3 class="sum-title">الملخّص</h3>
      <div class="sum-line">
        <span class="muted">بوابات الدخول</span>
        <span class="bold">{{ summaryForView.entryGatesCount }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">بوابات الخروج</span>
        <span class="bold">{{ summaryForView.exitGatesCount }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">عدد الباكيّات المسموح</span>
        <span class="bold">{{ summaryForView.allowedParkingSlots }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">فترة السماح (دقائق)</span>
        <span class="bold">{{ summaryForView.gracePeriodMinutes }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">الوضع</span>
        <span class="bold">{{ summaryForView.mode === 'entry' ? 'Entry' : 'Exit' }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">طريقة الالتقاط</span>
        <span class="bold">{{ summaryForView.captureMode }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">الطباعة</span> <span class="bold">{{ summaryForView.printType }}</span>
      </div>
      <div class="sum-line">
        <span class="muted">Start Date</span>
        <span class="bold">{{ summaryForView.ticketCard.startDate | date : 'yyyy-MM-dd' }}</span>
      </div>
    </mat-card>
  </div>
</div>
